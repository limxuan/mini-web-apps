<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repeat Timer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 32px;
      max-width: 500px;
      width: 100%;
      border: 1px solid #e5e5e5;
    }

    h1 {
      text-align: center;
      color: #1a1a1a;
      margin-bottom: 32px;
      font-size: 1.75em;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .config-section {
      margin-bottom: 32px;
    }

    .input-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #4a4a4a;
      font-weight: 500;
      font-size: 0.9em;
    }

    input[type="number"] {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #ffffff;
      color: #1a1a1a;
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #808080;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    .display-section {
      text-align: center;
      margin: 32px 0;
      padding: 40px 24px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
    }

    #timeDisplay {
      font-size: 3.5em;
      font-weight: 300;
      color: #1a1a1a;
      margin-bottom: 12px;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.03em;
    }

    #roundDisplay {
      font-size: 0.95em;
      color: #6a6a6a;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 32px;
    }

    button {
      padding: 14px 24px;
      font-size: 15px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      flex: 1;
      max-width: 120px;
      min-height: 44px;
      background: #ffffff;
      color: #1a1a1a;
      -webkit-tap-highlight-color: transparent;
    }

    button:hover {
      background: #f5f5f5;
      border-color: #b0b0b0;
    }

    button:active {
      background: #ebebeb;
      transform: scale(0.98);
    }

    #startBtn {
      background: #1a1a1a;
      color: #ffffff;
      border-color: #1a1a1a;
    }

    #startBtn:hover {
      background: #2a2a2a;
      border-color: #2a2a2a;
    }

    #startBtn:active {
      background: #0a0a0a;
    }

    #stopBtn {
      background: #4a4a4a;
      color: #ffffff;
      border-color: #4a4a4a;
    }

    #stopBtn:hover {
      background: #5a5a5a;
      border-color: #5a5a5a;
    }

    #stopBtn:active {
      background: #3a3a3a;
    }

    #resetBtn {
      background: #ffffff;
      color: #1a1a1a;
      border-color: #d0d0d0;
    }

    #resetBtn:hover {
      background: #f5f5f5;
      border-color: #b0b0b0;
    }

    #resetBtn:active {
      background: #ebebeb;
    }

    button:disabled {
      background: #f0f0f0;
      color: #a0a0a0;
      border-color: #e0e0e0;
      cursor: not-allowed;
      transform: none;
    }

    button:disabled:hover {
      background: #f0f0f0;
      border-color: #e0e0e0;
      transform: none;
      box-shadow: none;
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      body {
        padding: 12px;
        align-items: flex-start;
        padding-top: 24px;
      }

      .container {
        padding: 24px 20px;
        border-radius: 8px;
      }

      h1 {
        font-size: 1.5em;
        margin-bottom: 24px;
      }

      .config-section {
        margin-bottom: 24px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      label {
        font-size: 0.85em;
      }

      input[type="number"] {
        padding: 16px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .display-section {
        margin: 24px 0;
        padding: 32px 20px;
      }

      #timeDisplay {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      #roundDisplay {
        font-size: 0.85em;
      }

      .controls {
        margin-top: 24px;
        gap: 10px;
      }

      button {
        padding: 16px 20px;
        font-size: 14px;
        min-height: 48px;
        max-width: none;
      }
    }

    @media (max-width: 360px) {
      .container {
        padding: 20px 16px;
      }

      h1 {
        font-size: 1.35em;
      }

      #timeDisplay {
        font-size: 2em;
      }

      .controls {
        flex-direction: column;
      }

      button {
        width: 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Repeat Timer</h1>
    
    <div class="config-section">
      <div class="input-group">
        <label for="intervalInput">Interval Duration (seconds):</label>
        <input 
          type="number" 
          id="intervalInput" 
          min="1" 
          value="60" 
          required
        >
      </div>
      
      <div class="input-group">
        <label for="repeatInput">Number of Repeats:</label>
        <input 
          type="number" 
          id="repeatInput" 
          min="1" 
          value="5" 
          required
        >
      </div>
    </div>
    
    <div class="display-section">
      <div id="timeDisplay">0</div>
      <div id="roundDisplay">Round 0 / 0</div>
    </div>
    
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <script>
    /* ---------- DOM REFERENCES ---------- */
    const intervalInput = document.getElementById("intervalInput");
    const repeatInput = document.getElementById("repeatInput");
    const timeDisplay = document.getElementById("timeDisplay");
    const roundDisplay = document.getElementById("roundDisplay");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const resetBtn = document.getElementById("resetBtn");

    let timerId = null;
    let timeLeft = 0;
    let intervalSeconds = 0;
    let repeatTotal = 0;
    let currentRound = 0;

    /* ---------- BEEP ---------- */
    function beep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.1;

        osc.connect(gain);
        gain.connect(ctx.destination);

        osc.start();
        osc.stop(ctx.currentTime + 0.15);
      } catch (error) {
        console.warn("Audio playback not available:", error);
      }
    }

    /* ---------- FINAL BEEP ---------- */
    function finalBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Play three beeps with descending frequency to signal completion
        [660, 550, 440].forEach((freq, index) => {
          setTimeout(() => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.type = "sine";
            osc.frequency.value = freq;
            gain.gain.value = 0.15;

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.start();
            osc.stop(ctx.currentTime + 0.2);
          }, index * 150);
        });
      } catch (error) {
        console.warn("Audio playback not available:", error);
      }
    }

    /* ---------- NOTIFICATIONS ---------- */
    async function requestNotificationPermission() {
      if (!("Notification" in window)) {
        console.warn("This browser does not support notifications");
        return false;
      }

      if (Notification.permission === "granted") {
        return true;
      }

      if (Notification.permission !== "denied") {
        const permission = await Notification.requestPermission();
        return permission === "granted";
      }

      return false;
    }

    function showNotification(title, body, tag = null) {
      if (Notification.permission === "granted") {
        const options = {
          body: body,
          icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a1a1a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E",
          badge: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231a1a1a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E",
          tag: tag,
          requireInteraction: false
        };

        try {
          const notification = new Notification(title, options);
          
          // Auto-close notification after 3 seconds
          setTimeout(() => {
            notification.close();
          }, 3000);
        } catch (error) {
          console.warn("Failed to show notification:", error);
        }
      }
    }

    /* ---------- VALIDATION ---------- */
    function validateInputs() {
      const interval = Number(intervalInput.value);
      const repeat = Number(repeatInput.value);
      
      if (interval <= 0 || !Number.isInteger(interval)) {
        alert("Interval must be a positive integer");
        return false;
      }
      
      if (repeat <= 0 || !Number.isInteger(repeat)) {
        alert("Repeat count must be a positive integer");
        return false;
      }
      
      return true;
    }

    function updateDisplay() {
      timeDisplay.textContent = timeLeft;
      roundDisplay.textContent = `Round ${currentRound} / ${repeatTotal}`;
      
      // Update title bar with current state
      if (repeatTotal > 0) {
        document.title = `${timeLeft}s | Round ${currentRound}/${repeatTotal} - Repeat Timer`;
      } else {
        document.title = `Repeat Timer`;
      }
    }

    function updateButtonStates() {
      const isRunning = timerId !== null;
      startBtn.disabled = isRunning;
      stopBtn.disabled = !isRunning;
    }

    async function startTimer() {
      if (timerId) return;

      if (!validateInputs()) {
        return;
      }

      // Request notification permission when starting timer
      await requestNotificationPermission();

      intervalSeconds = Number(intervalInput.value);
      repeatTotal = Number(repeatInput.value);

      if (currentRound === 0) {
        currentRound = 1;
        timeLeft = intervalSeconds;
      }

      updateDisplay();
      updateButtonStates();

      timerId = setInterval(() => {
        timeLeft--;

        if (timeLeft <= 0) {
          if (currentRound >= repeatTotal) {
            finalBeep();
            showNotification(
              "Timer Complete",
              `All ${repeatTotal} rounds finished!`,
              "timer-complete"
            );
            stopTimer();
            return;
          }

          beep();
          showNotification(
            "Round Complete",
            `Round ${currentRound} of ${repeatTotal} finished`,
            `round-${currentRound}`
          );
          currentRound++;
          timeLeft = intervalSeconds;
        }

        updateDisplay();
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerId);
      timerId = null;
      updateButtonStates();
      updateDisplay();
    }

    function resetTimer() {
      stopTimer();
      
      if (!validateInputs()) {
        return;
      }
      
      currentRound = 0;
      intervalSeconds = Number(intervalInput.value);
      repeatTotal = Number(repeatInput.value);
      timeLeft = intervalSeconds;
      updateDisplay();
    }

    /* ---------- EVENT LISTENERS ---------- */
    startBtn.addEventListener("click", startTimer);
    stopBtn.addEventListener("click", stopTimer);
    resetBtn.addEventListener("click", resetTimer);

    // Prevent invalid input
    intervalInput.addEventListener("input", function() {
      if (this.value < 1) this.value = 1;
      if (!Number.isInteger(Number(this.value))) {
        this.value = Math.floor(Number(this.value));
      }
    });

    repeatInput.addEventListener("input", function() {
      if (this.value < 1) this.value = 1;
      if (!Number.isInteger(Number(this.value))) {
        this.value = Math.floor(Number(this.value));
      }
    });

    /* ---------- INITIALIZE ---------- */
    resetTimer();
  </script>
</body>
</html>
